resource_types:
- name: telegram-notification
  type: docker-image
  source:
    repository: w32blaster/concourse-telegram-notifier
    tag: latest

resources:
- name: status-message
  type: telegram-notification
  source:
    bot_token: ((tgram_token))
- name: repo
  type: git
  source:
    branch: BuildHealOps
    password: ((qgit_pass))
    uri: https://bengtssondd.it/git/healops.git
    username: qgit
- name: version
  type: semver
  source:
    branch: version
    driver: git
    file: version
    initial_version: 1.2.1
    password: ((qgit_pass))
    uri: https://bengtssondd.it/git/healops.git
    username: qgit

jobs:
- name: HealOps
  plan:
  - get: version
    params: {bump: minor}
  - get: repo
    trigger: true
  - task: build-HealOps
    config:
      platform: linux
      image_resource:
        source:
          repository: larssb/healopsci
          tag: 1.0.3
        type: docker-image
      inputs:
        - name: repo
      outputs:
        - name: BuildOutput
      run:
        path: pwsh
        args: ['-Command', "& { Invoke-Build -Task Build, RunAllTests -File repo/Build/HealOps.Build.ps1 }"]
  - task: publish-HealOps
    config:
      platform: linux
      image_resource:
        source:
          repository: larssb/healopsci
          tag: 1.0.3
        type: docker-image
      inputs:
        - name: BuildOutput
        - name: repo
        - name: version
      run:
        path: pwsh
        args: ['-Command', "& { Invoke-Build -Task Publish -File repo/Build/HealOps.Build.ps1 }"]
    on_success:
      put: version
      params: {file: version/version}
      on_success:
        put: status-message
        params:
          chat_id: "46668144"
          text: "HealOps was build > [The build number is $BUILD_NAME]."